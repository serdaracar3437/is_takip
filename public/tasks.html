<!-- public/tasks.html -->
<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Görev Listesi</title>

<style>
  body { margin:0; font-family:Inter,Arial; background:#f4f6fc; color:#111 }
  .header { background:#2c003e; color:#fff; padding:20px; text-align:center; font-weight:700 }
  .wrap { max-width:1400px; margin:18px auto; padding:12px }
  .panel { display:flex; gap:8px; flex-wrap:wrap; margin-bottom:12px }
  input { padding:10px; border-radius:8px; border:1px solid #ddd }
  .btn { background:#ff6f00; color:white; border:none; padding:10px 14px; border-radius:8px; cursor:pointer }
  table { width:100%; border-collapse:collapse; background:white; border-radius:8px; overflow:hidden; font-size:14px }
  th { background:#ff6f00; color:white; padding:10px; white-space:nowrap }
  td { padding:10px; border-top:1px solid #f1f1f1; vertical-align:top }
  tr:hover td { background:#fff7ed }
  .edit-btn { background:#2c003e; color:white; padding:6px 10px; border-radius:6px; cursor:pointer; border:none }
</style>
</head>

<body>
<div class="header">Görev Listesi</div>

<div class="wrap">

  <!-- Filtre Alanı -->
  <div class="panel">
    <input id="f_username" placeholder="Personel">
    <input id="f_isemri" placeholder="İş Emri No">
    <input id="f_tarih" type="date">
    <button class="btn" onclick="loadTasks()">Filtrele</button>
    <button class="btn" onclick="exportCSV()">CSV İndir</button>
    <button class="btn" onclick="window.print()">PDF (Yazdır)</button>
    <a class="btn" href="personel.html" style="text-decoration:none">Yeni Görev</a>
  </div>

  <!-- Tablo -->
  <table>
    <thead>
      <tr>
        <th>Personel</th>
        <th>İş Emri</th>
        <th>Ürün</th>
        <th>Tarih</th>
        <th>Faaliyet</th>
        <th>Açıklama</th>
        <th>Malzeme</th>
        <th>Başlama</th>
        <th>Bitiş</th>
        <th>Adet</th>
        <th>Hata 1</th>
        <th>Hata 2</th>
        <th>Hata 3</th>
        <th>Düzenle</th>
      </tr>
    </thead>
    <tbody id="taskTable"></tbody>
  </table>

</div>

<script>
// --------------------- ADMIN KONTROLÜ ---------------------
const IS_ADMIN = localStorage.getItem("role") === "admin";

// --------------------- LOAD TASKS ---------------------
async function loadTasks() {
  const q = new URLSearchParams({
    username: f_username.value.trim(),
    isemri_numarasi: f_isemri.value.trim(),
    tarih: f_tarih.value || ""
  });

  const res = await fetch("/api/tasks?" + q);
  const data = await res.json();

  const tbody = document.getElementById("taskTable");
  tbody.innerHTML = "";

  if (!Array.isArray(data) || data.length === 0) {
    tbody.innerHTML = `<tr><td colspan="14" style="text-align:center;padding:18px;color:#777">Kayıt yok</td></tr>`;
    return;
  }

  data.forEach(t => {
    const tr = document.createElement("tr");

    tr.innerHTML = `
      <td>${t.username}</td>
      <td>${t.isemri_numarasi || "-"}</td>
      <td>${t.urun_kodu || "-"}</td>
      <td>${t.tarih || "-"}</td>
      <td>${t.yapilan_faaliyet || "-"}</td>
      <td>${t.aciklama || "-"}</td>
      <td>${t.kullanilan_malzeme || "-"}</td>
      <td>${t.baslama_saati || "-"}</td>
      <td>${t.bitis_saati || "-"}</td>
      <td>${t.islem_adedi || "-"}</td>

      <td>${t.hata_kodu1 ? `${t.hata_kodu1} (${t.hata_sayisi1})` : "-"}</td>
      <td>${t.hata_kodu2 ? `${t.hata_kodu2} (${t.hata_sayisi2})` : "-"}</td>
      <td>${t.hata_kodu3 ? `${t.hata_kodu3} (${t.hata_sayisi3})` : "-"}</td>

      <td>${
        IS_ADMIN
          ? `<button class="edit-btn" onclick="editTask(${t.id})">Düzenle</button>`
          : ""
      }</td>
    `;

    tbody.appendChild(tr);
  });
}

loadTasks();

// --------------------- EDIT ---------------------
function editTask(id) {
  window.location.href = "edit-task.html?id=" + id;
}
</script>

</body>
</html>
