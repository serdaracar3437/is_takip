<!-- public/edit-task.html -->
<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>GÃ¶rev DÃ¼zenle</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
  body { 
    margin:0; 
    font-family:Inter,Arial; 
    background:#f4f6fc;
    color:#111;
  }
  .header { 
    background:#2c003e; 
    color:#fff; 
    padding:20px; 
    text-align:center; 
    font-weight:700; 
    font-size:20px 
  }
  .wrap {
    max-width:900px;
    background:white;
    margin:30px auto;
    padding:25px;
    border-radius:12px;
    box-shadow:0 4px 20px rgba(0,0,0,0.1);
  }

  h2 { text-align:center; margin-top:0; }

  .grid {
    display:grid;
    grid-template-columns:repeat(2,1fr);
    gap:16px;
  }

  .grid-1 {
    display:grid;
    grid-template-columns:1fr;
    gap:16px;
    margin-top:15px;
  }

  label { font-weight:600; }

  input, textarea {
    width:100%;
    padding:10px;
    border-radius:8px;
    border:1px solid #ccc;
  }

  textarea { height:70px; resize:none; }

  .btn {
    padding:12px 20px;
    border:none;
    border-radius:8px;
    cursor:pointer;
    font-weight:700;
  }

  .save-btn { background:#ff6f00; color:white; }
  .delete-btn { background:#b30000; color:white; }
  .back-btn { background:#777; color:white; }

  .row-btns {
    display:flex;
    justify-content:space-between;
    margin-top:25px;
  }
</style>
</head>
<body>

<div class="header">GÃ¶revi DÃ¼zenle</div>

<div class="wrap">

  <h2>GÃ¶rev Bilgileri</h2>

  <div class="grid">

    <div>
      <label>Personel</label>
      <input id="username">
    </div>

    <div>
      <label>Ä°ÅŸ Emri</label>
      <input id="isemri_numarasi">
    </div>

    <div>
      <label>ÃœrÃ¼n Kodu</label>
      <input id="urun_kodu">
    </div>

    <div>
      <label>Tarih</label>
      <input id="tarih" type="date">
    </div>

    <div>
      <label>BaÅŸlama Saati</label>
      <input id="baslama_saati" type="time">
    </div>

    <div>
      <label>BitiÅŸ Saati</label>
      <input id="bitis_saati" type="time">
    </div>

    <div>
      <label>Ä°ÅŸlem Adedi</label>
      <input id="islem_adedi">
    </div>

  </div>

  <div class="grid-1">
    <div>
      <label>YapÄ±lan Faaliyet</label>
      <textarea id="yapilan_faaliyet"></textarea>
    </div>

    <div>
      <label>AÃ§Ä±klama</label>
      <textarea id="aciklama"></textarea>
    </div>

    <div>
      <label>KullanÄ±lan Malzeme</label>
      <textarea id="kullanilan_malzeme"></textarea>
    </div>
  </div>

  <h3 style="margin-top:25px;">Hata Bilgileri</h3>
  <div class="grid">

    <div>
      <label>Hata Kodu 1</label>
      <input id="hata_kodu1">
    </div>
    <div>
      <label>Hata SayÄ±sÄ± 1</label>
      <input id="hata_sayisi1">
    </div>

    <div>
      <label>Hata Kodu 2</label>
      <input id="hata_kodu2">
    </div>
    <div>
      <label>Hata SayÄ±sÄ± 2</label>
      <input id="hata_sayisi2">
    </div>

    <div>
      <label>Hata Kodu 3</label>
      <input id="hata_kodu3">
    </div>
    <div>
      <label>Hata SayÄ±sÄ± 3</label>
      <input id="hata_sayisi3">
    </div>

  </div>

  <div class="row-btns">
    <button class="back-btn btn" onclick="history.back()">â¬… Geri</button>
    <button class="delete-btn btn" onclick="deleteTask()">ðŸ—‘ Sil</button>
    <button class="save-btn btn" onclick="saveTask()">ðŸ’¾ Kaydet</button>
  </div>

</div>

<script>
const params = new URLSearchParams(window.location.search);
const taskId = params.get("id");

if (!taskId) {
  alert("GeÃ§ersiz gÃ¶rev ID");
  location.href = "tasks.html";
}

// Sadece admin kontrolÃ¼
if (localStorage.getItem("role") !== "admin") {
  alert("Bu sayfaya eriÅŸim yetkiniz yok");
  location.href = "tasks.html";
}


// ------------------------
// GÃ–REVÄ° YÃœKLE
// ------------------------
async function loadTask() {
  const res = await fetch("/api/tasks?id=" + taskId);
  let data = await res.json();

  // Tek kayÄ±t dÃ¶nmeli
  if (Array.isArray(data)) data = data[0];

  if (!data) {
    alert("KayÄ±t bulunamadÄ±");
    location.href = "tasks.html";
    return;
  }

  // Inputlara doldur
  for (const key in data) {
    if (document.getElementById(key)) {
      document.getElementById(key).value = data[key] || "";
    }
  }
}

loadTask();


// ------------------------
// GÃ–REVÄ° KAYDET
// ------------------------
async function saveTask() {
  const payload = {};

  document.querySelectorAll("input, textarea").forEach(el => {
    payload[el.id] = el.value.trim();
  });

  const res = await fetch("/api/updateTask/" + taskId, {
    method:"PUT",
    headers:{"Content-Type":"application/json"},
    body: JSON.stringify(payload)
  });

  const j = await res.json();

  if (!res.ok) {
    alert("Hata: " + j.error);
    return;
  }

  alert("GÃ¶rev gÃ¼ncellendi!");
  location.href = "tasks.html";
}



// ------------------------
// GÃ–REVÄ° SÄ°L
// ------------------------
async function deleteTask() {
  if (!confirm("Bu kayÄ±t silinsin mi?")) return;

  const res = await fetch("/api/deleteTask/" + taskId, { method:"DELETE" });

  if (res.ok) {
    alert("GÃ¶rev silindi!");
    location.href = "tasks.html";
  } else {
    alert("Silme hatasÄ±");
  }
}
</script>

</body>
</html>
